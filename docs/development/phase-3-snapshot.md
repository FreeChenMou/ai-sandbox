# 阶段3：快照与恢复 (第5-6周)

**关键里程碑**：支持Agent状态保存和快速恢复，大幅提升Workflow性能

**核心目标**：
- ✅ 能对运行的进程做checkpoint
- ✅ 能从快照快速恢复（<500ms）
- ✅ 快照数据完整且一致
- ✅ 支持快照预热加速启动

**阶段验收标准**：
- CRIU快照功能正常
- 恢复后进程状态一致
- 快照占用空间可接受（<200MB）
- 支持顺序任务快速恢复

---

## 模块列表

| 模块 | 周数 | 难度 | 关键度 |
|------|------|------|--------|
| [3.1 CRIU快照集成](./modules/module-3.1-criu.md) | 1.5周 | ★★★★★ | 🔴 关键 |
| [3.2 热启动优化](./modules/module-3.2-warmup.md) | 0.5周 | ★★★ | 🟡 优化 |

---

## 技术挑战

### CRIU 兼容性
- 需要特定的内核版本支持
- 某些特性可能不支持（如某些特殊进程）
- 解决方案：早期PoC验证，选择稳定配置

### 快照大小
- 预期：一个Python解释器快照 100-200MB
- 优化：增量快照、压缩

### 恢复一致性
- 环境变量、文件描述符、网络连接等需保存
- 需要详细的验证和测试

---

## 验收标准

### CRIU模块
- ✅ 能对Python/Node.js进程checkpoint
- ✅ 快照包含完整的进程状态
- ✅ restore后进程功能等价
- ✅ 快照文件<200MB
- ✅ 恢复时间<500ms

### 热启动模块
- ✅ 预热快照启动<50ms
- ✅ 功能等价性验证

---

## 相比阶段2的改进

| 能力 | 阶段2后 | 阶段3后 |
|------|---------|---------|
| **顺序任务** | 单独执行 | 快速恢复 |
| **启动时间** | 50ms | 20ms（预热） |
| **故障恢复** | 重启整个任务 | 从快照恢复 |
| **Workflow性能** | 基础 | 优化 |

---

## 关键特性

### 选择性快照
- 关键任务节点保存完整快照
- 常规任务保存轻量快照
- 失败任务不保存

### 增量快照
- 仅保存变化的内存页
- 减少存储占用
- 加速恢复

---

**更新日期**：2024-02-10
