# 阶段3：快照与恢复 (第5-6周)

**关键里程碑**：支持Agent状态保存和快速恢复，大幅提升Workflow性能

**核心目标**：
- ✅ 能对运行的进程做checkpoint
- ✅ 能从快照快速恢复（<500ms）
- ✅ 快照数据完整且一致
- ✅ 支持快照预热加速启动

**阶段验收标准**：
- CRIU快照功能正常
- 恢复后进程状态一致
- 快照占用空间可接受（<200MB）
- 支持顺序任务快速恢复

---

## 核心问题

本阶段的设计围绕以下三个核心问题展开：

### 问题1：启动延迟

新建沙盒需要完成 Namespace 创建、OverlayFS 挂载、Cgroups 配置、Seccomp 加载等一系列初始化操作，总耗时可达数百毫秒甚至秒级。对于需要频繁创建沙盒的 Workflow 场景，累积的启动延迟严重影响整体性能。

**解决方案**：通过 CRIU 快照恢复跳过初始化流程，实现亚秒级响应；预热机制预创建暂停态沙盒，激活仅需 thaw 操作（< 50ms）。

### 问题2：内存占用

大量并发沙盒各自持有独立的内存空间，完整快照每个 100-200MB，N 个沙盒的快照存储随规模线性增长。

**解决方案**：通过增量快照（`--track-mem` 脏页跟踪）仅保存修改的内存页；通过链式快照（`--prev-images-dir`）建立 base → delta1 → delta2 的存储结构，典型场景下存储节省 60% 以上。

### 问题3：服务可用性

沙盒进程可能因 OOM、未处理信号、内部错误等原因意外退出，导致 Agent 运行状态丢失，需要从零重新执行。

**解决方案**：通过原子状态转换（freeze → checkpoint → resume）保证快照一致性；完整状态快照支持从任意保存点恢复；自动故障检测 + 快照恢复实现服务连续性。

---

## 模块列表

| 模块 | 周数 | 难度 | 关键度 | 说明 |
|------|------|------|--------|------|
| [3.1 CRIU快照集成](./modules/module-3.1-criu.md) | 1.5周 | ★★★★★ | 🔴 关键 | CRIU checkpoint/restore、增量快照、链式快照 |
| [3.2 预热与快速恢复](./modules/module-3.2-warmup.md) | 0.5周 | ★★★ | 🟡 优化 | 预热池、故障检测、自动恢复 |

---

## 技术挑战

### CRIU 兼容性
- 需要特定的内核版本支持（>= 4.19，推荐 5.4+）
- 需要内核配置 `CONFIG_CHECKPOINT_RESTORE=y`
- 增量快照需要 `CONFIG_MEM_SOFT_DIRTY=y`
- 解决方案：早期 PoC 验证，选择稳定配置

### 快照大小
- 预期：一个 Python 解释器快照 100-200MB
- 优化：增量快照（仅保存脏页）、链式快照（引用父快照）
- 目标：增量快照 < 50MB

### 恢复一致性
- 内存映射、文件描述符、信号处理、网络连接等需完整保存
- OverlayFS upper 层需要同步备份
- Cgroups 状态需要恢复后重新应用
- 需要详细的验证和测试

### 原子性保证
- checkpoint 过程中不能让进程产生新的状态变更
- 快照文件写入需要原子性（临时目录 + rename）
- 恢复过程需要回滚能力（失败时清理半成品）

---

## 验收标准

### CRIU 快照模块（模块3.1）
- ✅ 能对 Python/Node.js 进程 checkpoint
- ✅ 快照包含完整的进程状态（内存、fd、信号、环境变量）
- ✅ restore 后进程功能等价
- ✅ 完整快照文件 < 200MB（512MB 内存沙盒）
- ✅ 完整快照恢复时间 < 500ms
- ✅ 增量快照时间 < 500ms
- ✅ 增量快照大小 < 50MB（典型修改量）
- ✅ 链式快照恢复正确合并
- ✅ 快照校验检测损坏文件

### 预热与恢复模块（模块3.2）
- ✅ 预热池激活 < 50ms
- ✅ 故障恢复 < 500ms
- ✅ 功能等价性验证
- ✅ 池水位自动维持
- ✅ 并发 Acquire/Release 安全

---

## 相比阶段2的改进

| 能力 | 阶段2后 | 阶段3后 |
|------|---------|---------|
| **顺序任务** | 每次从零创建沙盒 | 快照恢复 / 预热池激活 |
| **启动时间** | ~50ms（创建 Namespace） | < 50ms（预热池激活） |
| **故障恢复** | 重启整个任务（状态丢失） | 从快照恢复（保留状态） |
| **内存快照** | 不支持 | 完整 + 增量快照 |
| **Workflow性能** | 基础 | 显著优化 |

---

## 关键特性

### 选择性快照
- 关键任务节点保存完整快照
- 常规任务保存增量快照
- 失败任务不保存

### 增量快照
- 仅保存变化的内存页（soft-dirty bit 跟踪）
- 链式存储减少总占用（节省 60%+）
- MaxChainLength 控制链深度，避免恢复过慢

### 预热池
- 预创建暂停态沙盒，按需激活
- 后台自动补充，前台无感知
- 支持优雅关闭和滚动替换

---

**更新日期**：2025-02-12
