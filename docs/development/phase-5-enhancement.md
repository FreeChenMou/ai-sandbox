# 阶段5：可选增强层 (第10周+)

**关键里程碑**：高级安全和可观测能力（可选，按需选择）

**核心目标**：
- ✅ 实时内核级监控（eBPF追踪）
- ✅ 异常行为检测
- ✅ 动态安全策略
- ✅ 完整的可审计性

**阶段验收标准**：
- eBPF能采集所有syscall
- 异常检测准确率>95%
- 对性能影响<5%
- 支持超大规模部署（10K+并发）

---

## 模块列表

| 模块 | 周数 | 难度 | 关键度 | 优先级 |
|------|------|------|--------|--------|
| [5.1 eBPF Syscall追踪](./modules/module-5.1-ebpf.md) | 2周 | ★★★★★ | 🔵 可选 | P3 |
| [5.2 异常检测和动态控制](./modules/module-5.2-detection.md) | 2周 | ★★★★ | 🔵 可选 | P3 |

---

## 为什么是可选的？

1. **系统可用性强**
   - 阶段1-4已经满足大多数场景
   - 安全性已达到生产级别（Seccomp+Chroot）

2. **复杂度和成本**
   - 需要深度eBPF知识
   - 学习曲线陡峭
   - 只在大规模部署时值得投入

3. **内核要求**
   - eBPF LSM需要Linux 5.8+
   - 跨版本兼容性差

---

## 何时启用增强层

### 推荐启用（优先级高）
- ✅ 并发Agent数 > 5000
- ✅ 需要执行完全不可信代码
- ✅ 金融/医疗等合规要求极高
- ✅ 需要实时威胁检测

### 可不启用（成本>收益）
- ❌ 并发Agent < 5000
- ❌ 代码来自内部或高可信来源
- ❌ 运维团队无专业eBPF知识
- ❌ 快速上市优先于完全可观测性

---

## 增强层的能力

### eBPF追踪
```
系统调用 → eBPF程序 → 采集 → 用户态处理
  (内核态)     (100%准确)
```

**可采集**：
- 所有系统调用（100%准确，零遗漏）
- 调用参数和返回值
- 内存访问模式
- 网络包级信息

**用途**：
- 完整的审计日志
- 行为重放和调试
- 异常检测

### 异常检测
```
行为数据 → AI模型 → 判定 → 动作
  (内核采集)    (分类)  (允许/拒绝/限流)
```

**检测项**：
- CPU异常使用（恶意loop）
- 网络异常访问（未授权DNS）
- 文件系统异常（逃逸尝试）
- 权限提升尝试

### 动态控制
```
异常检测 → 决策 → 更新规则 → 实时生效
         (Notify)
```

**支持**：
- 优先级动态调整
- CPU份额动态限流
- 规则动态更新（秒级）

---

## 相比阶段4的改进

| 能力 | 阶段4后 | 阶段5后 |
|------|---------|---------|
| **可观测性** | 进程级 | 系统调用级 |
| **异常检测** | 阈值告警 | AI行为分析 |
| **防护层次** | 2层 | 3+层 |
| **支持规模** | 5K并发 | 50K+并发 |
| **安全等级** | 生产级 | 金融级 |

---

## 技术风险

### 1. 内核版本要求
- **问题**：需要Linux 5.8+
- **解决**：在支持的环境部署，或提供兼容方案

### 2. 调试困难
- **问题**：eBPF程序崩溃难以诊断
- **解决**：充分的单元测试，使用bpftool调试

### 3. 性能抖动
- **问题**：GC或其他因素导致延迟
- **解决**：使用Ring Buffer代替perf buffer

---

## 分阶段启用策略

### Phase 5.1（仅用于关键任务）
```yaml
critical_tasks:
  - task_id: "financial_analysis"
    ebpf_monitor: true    # 启用监控
    priority: 100

regular_tasks:
  - task_id: "data_process"
    ebpf_monitor: false   # 不监控
    priority: 50
```

### Phase 5.2（逐步扩大范围）
- 先监控关键任务（1%）
- 扩展到重要任务（10%）
- 最终覆盖所有任务

---

## 投资回报

如果满足以下条件，建议投入阶段5：

```
总收益 = 风险降低价值 + 成本节约
如果：
  - 并发Agent > 10K （每个Agent有安全风险）
  - 或者需要金融级审计
  - 或者有专业eBPF团队
⟹ 投资阶段5值得
```

---

## 参考指标

### 增强层性能开销
| 操作 | 开销 | 说明 |
|------|------|------|
| Syscall采集 | <100μs | eBPF JIT编译后性能接近原生 |
| 采集数据上报 | <50μs | Ring buffer零拷贝 |
| 异常判定 | <1ms | 轻量级AI模型 |
| **总体影响** | <5% | 对整体系统可接受 |

---

**更新日期**：2024-02-10
