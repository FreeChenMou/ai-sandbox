## 核心技术架构 (Technical Architecture)

本项目采用轻量级隔离方案，通过 Go 语言直接操作底层 Linux 命名空间（Namespace）与控制组（Cgroups）实现沙箱隔离。整体架构分为三层：基础隔离层、可选增强层和应用编排层。

### 🏗️ 架构分层设计

```
┌────────────────────────────────────────────────────┐
│        Workflow 编排层 (DAG/任务调度)              │
│    顺序执行 / 并行执行 / 并发控制                  │
└────────────────────────────────────────────────────┘
                        ↓
┌────────────────────────────────────────────────────┐
│    可选增强层 (eBPF监控/异常检测) - 按需启用      │
│  • eBPF Syscall 追踪   • 实时异常检测              │
│  • LSM文件系统防护     • 动态优先级控制            │
│  • Seccomp Notify      • 流量整形(TC/XDP)         │
└────────────────────────────────────────────────────┘
                        ↓
┌────────────────────────────────────────────────────┐
│    核心隔离层 (必选) - 生产级隔离                  │
│  ├─ 多维资源隔离                                  │
│  ├─ 内核级权限控制                                │
│  └─ 快照与恢复机制                                │
└────────────────────────────────────────────────────┘
```

### 🛡️ 模块一：多维资源隔离 (Multi-Layer Resource Isolation)

**目标**：防止 Agent 任务出现"吵闹邻居"效应，确保宿主机稳定性。

**技术实现**：

- **计算与内存围栏**：基于 Cgroups v2 实现 CPU 份额（CPU Shares）的硬限制与内存带宽控制，杜绝 OOM 连锁反应。支持动态资源分配和重分配。

- **临时文件系统（Ephemeral FS）**：利用 OverlayFS 构建写时复制（CoW）的文件层。每个 Agent 启动时挂载独立的只读根目录，所有写入操作仅发生在内存层的 UpperDir 中，任务结束即销毁，确保环境"无状态"且不浪费磁盘 I/O。

- **网络命名空间**：默认构建隔离的 Network Namespace，通过 veth pair 虚拟网卡桥接，仅允许特定端口的出站流量。支持网络策略定制。

### 🔐 模块二：内核级权限控制 (Kernel-Level Permission Control)

**目标**：实现从应用层到内核层的纵深防御，防止恶意代码逃逸。

**技术实现**：

- **系统调用过滤 (Seccomp-BPF)**：预加载严格的 Seccomp 白名单 profile。仅开放 read, write, futex 等基础 syscall，直接在内核态拦截并阻断 socket (监听), ptrace (调试), mount (挂载) 等危险调用。

- **动态路径锚定**：利用 Chroot/Pivot_root 将进程监狱化在特定目录下。

- **API 流量审计**：在用户态实现透明代理（Sidecar Proxy），解析 Agent 发出的 HTTP 请求，基于预设策略拦截未授权的域名访问或敏感数据传输。

### 📸 模块三：即时快照与恢复 (Instant Snapshot & Restore)

**目标**：解决复杂 Agent 任务的长耗时问题，支持"时间旅行"调试和故障恢复。

**技术实现**：

- **用户态检查点 (CRIU Integration)**：集成 CRIU (Checkpoint/Restore In Userspace) 技术，能够冻结正在运行的 Python/Node.js 解释器。

- **内存页转储**：将进程的虚拟内存空间、文件描述符表（FD Table）、寄存器状态序列化为镜像文件。

- **热启动优化**：支持从"预热好的快照"启动新沙箱（Fork from Snapshot）。相比传统的 docker run，将环境初始化时间从 1s+ 降低至 50ms 以内，极大提升了 Agent 的交互响应速度。

---

## 可选增强能力

在核心隔离层基础上，项目支持可选的增强能力，用于高级场景（大规模并发、恶意代码检测等）。

### 🚀 增强层：内核级精细控制（可选）

**适用场景**：并发Agent > 5000、需要异常检测、用户代码完全不可信

**增强能力**：

- **eBPF Syscall 追踪**：在内核态实时采集所有系统调用（100% 准确、零遗漏）
  - 完整的行为审计
  - 内存页访问模式分析
  - 性能事件采样（CPU cycles、cache miss）

- **LSM 文件系统防护**：内核级Hook防止跨Agent数据访问
  - 精细化的文件访问控制
  - 防止敏感数据泄露
  - 隔离验证

- **Seccomp Notify 模式**：用户态动态决策
  - 可疑Syscall触发审批
  - 基于AI模型判定异常
  - 动态规则更新

- **流量整形与限流**：TC (Traffic Control) + XDP
  - 基于行为自适应的CPU分配
  - 网络包级过滤
  - 优先级感知的资源分配

**关键指标对比**：

| 指标 | 核心层 | 增强层 | 差异 |
|------|-------|--------|------|
| 单Agent启动延迟 | 50ms | 20-50ms | 规则预编译可优化 |
| Syscall可观测性 | 有限（进程级） | 完整（内核级，100%准确） | 增强层可见所有调用 |
| 异常检测能力 | 基础（资源阈值） | 高级（行为分析） | eBPF可检测隐蔽攻击 |
| 故障诊断信息 | 中等 | 详细（完整调用链） | 增强层可完整重放 |
| 复杂度成本 | 低 | 高（需专业团队维护） | 值得用于大规模部署 |

---

## Agent Workflow 编排场景

本项目的核心应用是多Agent协作的Workflow编排，支持三种任务模式。

### 📋 三种任务类型

#### 1. 顺序任务 (Sequential)

**特征**：Agent1 → Agent2 → Agent3 → ...

**核心需求**：
- 前置Agent输出作为后续Agent的输入
- 一个失败导致整个流程失败
- 快速故障恢复能力

**推荐方案**：
- 每个完成任务执行 CRIU 快照保存
- 故障时从快照点恢复（100-500ms）相比重新启动的快速恢复
- 支持从任意快照点重做后续任务
- 性能：10个顺序任务约 550ms（基础启动 50ms×10），或通过快照恢复优化至 250ms

**技术特性**：
- 利用 CRIU 增量快照机制减少存储开销
- Cgroups 资源隔离确保任务间独立
- OverlayFS 写时复制确保任务环境隔离

#### 2. 并行任务 (Parallel)

**特征**：多个Agent同时运行，等待所有完成后汇聚结果

**核心需求**：
- 多个Agent并发执行
- 等待所有Agent完成后汇总结果
- 共享资源不超出硬件限制

**推荐方案**：
- 使用共享 Cgroup 管理整体资源池
- Cgroups v2 自动实现公平的 CPU/内存分配
- 信号量机制防止并发数超限
- 支持大规模并行：100个并行Agent在8核CPU下，Cgroups自动分配每个Agent 80m CPU

**技术特性**：
- Cgroups v2 分层结构实现细粒度资源控制
- Namespace 隔离确保Agent间进程树独立
- 信号量限流防止瞬时并发爆发

#### 3. 并发任务 (Concurrent)

**特征**：动态数量的Agent并发执行，需要优先级和动态资源分配

**两种执行模式**：

*模式一：纯资源限制（不启用增强层）*
- 使用核心隔离层的 Cgroups 资源限制
- 资源限制到物理硬件边界
- 适用于并发 < 5000 的场景
- 成本低，管理简单，无需额外的异常检测

*模式二：大规模+异常检测（可选启用增强层）*
- 启用eBPF监控关键任务的系统调用
- 检测CPU/网络异常行为
- 基于实时行为数据动态调整优先级
- 适用于并发 > 5000 或需要恶意代码检测的场景
- 成本较高，但显著提升安全性和可观测性

**技术特性**：
- Cgroups v2 提供硬限制和柔性配额
- 增强层的eBPF追踪提供内核态的完整可见性
- Seccomp Notify 模式支持用户态审批机制

### 🔧 Workflow 编排最佳实践

#### 快照策略

在顺序任务执行中，选择性保存快照可以平衡存储成本和恢复速度：
- 常规任务保存轻量快照（占用空间小）
- 关键任务节点保存完整快照（用于恢复）
- 失败任务不保存快照，而是从前一个完整快照恢复后重试

**故障恢复方式**：
- 优先选项：从失败点的前一个快照恢复，重新执行失败的任务（100-500ms恢复时间）
- 备选方案：完整重做所有任务（仅在快照损坏等极端情况）

#### 数据传递

不同场景下的三种传递方式：

1. **共享文件系统**（适合大数据传输）
   - 利用 OverlayFS 的共享层
   - 延迟：5-10ms
   - 适用：单次数据 > 100MB

2. **Unix Socket/管道**（适合流式输出）
   - 进程间通信原语
   - 延迟：1-2ms
   - 适用：流式数据、单次 < 100MB

3. **增强层 BPF Map**（适合超低延迟，可选）
   - 内核空间共享内存
   - 延迟：< 1ms
   - 适用：需要亚毫秒级延迟的任务

#### 并发控制

推荐的并发控制架构：

- **资源池管理**：设定总的 CPU、内存预算，各个Agent从中分配
- **优先级队列**：区分关键任务（金融计算）、普通任务、后台任务，优先调度关键任务
- **Cgroup 协调**：在共享 Cgroup 下创建沙箱，自动实现资源的公平分配和强制限制
- **可选监控**：为高优先级任务启用eBPF，实时监测异常行为

### 📊 Workflow 编排执行过程

ai-sandbox 在Workflow编排中的核心执行阶段：

1. **定义阶段**：描述任务DAG（有向无环图）和任务间依赖关系

2. **调度阶段**：调度器根据任务特性选择合适的隔离方案
   - 顺序任务启用快照机制
   - 并行任务使用共享Cgroup
   - 关键任务可选启用eBPF监控

3. **创建阶段**：为每个任务创建隔离环境
   - 创建独立的Namespace（PID/IPC/Mount/Network）
   - 挂载OverlayFS文件系统层
   - 配置Cgroup资源限制
   - 安装Seccomp规则

4. **执行阶段**：运行Agent进程
   - fork 和 exec Agent进程
   - 内核态拦截系统调用并应用Seccomp规则
   - 可选：eBPF实时监控关键任务的行为

5. **收尾阶段**：结果处理和清理
   - 成功执行：保存快照（可选）
   - 失败执行：从快照恢复或重试
   - 清理：销毁Namespace和OverlayFS层，释放Cgroup配额

---

## 性能指标与对标

### 核心性能指标

| 指标 | 数值 | 说明 |
|------|------|------|
| **单Agent启动延迟** | 50ms | 基础隔离，正常启动 |
| **快照恢复时间** | 100-500ms | CRIU热启动，可优化至20-30ms |
| **Syscall拦截开销** | <50μs | Seccomp-BPF在内核态 |
| **内存占用/沙箱** | 5-20MB | 基础隔离 + 应用代码 |
| **单主机并发密度** | 10K+ | Cgroups限制下 |
| **Cgroup资源隔离准确度** | ±2-5% | CPU、内存精确控制 |
| **增强层Syscall追踪延迟** | <100μs | eBPF BPF JIT编译后 |

### 对标其他方案

```
性能对比（相对数值）：

                启动速度  资源占用  隔离强度  易用性  成本
Docker/OCI      ★★☆      ★★☆      ★★★★★   ★★★★  ★★★
KVM/Hyper-V     ★☆☆      ★☆☆      ★★★★★   ★☆☆   ★☆☆
ai-sandbox      ★★★★★    ★★★★★    ★★★★    ★★★★  ★★★★
WASM            ★★★★★    ★★★★★    ★★★     ★★★   ★★★

特点总结：
✓ ai-sandbox = 启动速度 + 资源效率 + 隔离强度的最佳平衡
✓ 特别适合 Agent Workflow 编排（频繁启动、高并发）
✓ 可选增强层提供与顶级方案相当的安全能力
```

---

## 快速选型指南

### 何时选择核心隔离层（推荐default）

```
✓ 日均并发 < 5000
✓ 95%代码来自内部或可信来源
✓ 运维团队 < 5人
✓ Python/Node.js 为主
✓ 任务以短期为主（<10s）
✓ 快速上市时间优先
✓ 成本压力大
```

→ **推荐**：直接使用核心隔离层，快速上线，成本低。

### 何时启用增强层（可选）

```
✗ 日均并发 > 5000
✗ 用户代码完全不可信
✗ 需要实时威胁检测
✗ 合规要求高（金融、医疗）
✗ 无法接受任何数据泄露风险
✗ 有专业安全和SRE团队
✗ 愿意投入较高运维成本
```

→ **选择**：逐步启用增强层，为关键任务加入eBPF监控。

---

## 总结

**ai-sandbox** 采用分层架构设计：

1. **核心隔离层**（必选）：轻量、高效、可靠
   - 适合大多数 Agent Workflow 场景
   - 50ms 启动、10K+ 并发密度
   - 2-4周快速上线

2. **可选增强层**（按需）：内核级可观测性和安全
   - 用于大规模部署或高安全需求
   - eBPF 完整行为追踪
   - 异常检测和动态控制
   - 增量开发成本：2-4周

**推荐策略**：
- **阶段1**（MVP）：100% 使用核心隔离层
- **阶段2**（优化）：为关键任务启用增强层
- **阶段3**（规模化）：基于运维反馈不断迭代